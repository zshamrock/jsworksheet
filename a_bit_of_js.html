<!DOCTYPE html>
<html>
<head>
	<title>A bit of JavaScript</title>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.9.1/themes/base/jquery-ui.css" />    	
    	<script src="http://code.jquery.com/ui/1.9.1/jquery-ui.js"></script>

	<link href="http://alexgorbatchev.com/pub/sh/current/styles/shThemeDefault.css" rel="stylesheet" type="text/css" />
	<link type="text/css" rel="Stylesheet" href="http://alexgorbatchev.com/pub/sh/current/styles/shThemeEclipse.css"/>

	<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shCore.js" type="text/javascript"></script>
	<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushJScript.js" type="text/javascript"></script>
	<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shAutoloader.js" type="text/javascript"></script>

	<link rel="stylesheet" type="text/css" href="codemirror-2.35/lib/codemirror.css">
	
	<script type="text/javascript" src="codemirror-2.35/lib/codemirror.js"></script>
	<script type="text/javascript" src="codemirror-2.35/lib/util/javascript-hint.js"></script>	

	<script type="text/javascript" src="codemirror-2.35/lib/util/simple-hint.js"></script>
    	<link rel="stylesheet" type="text/css" href="codemirror-2.35/lib/util/simple-hint.css">
    	<script type="text/javascript" src="codemirror-2.35/lib/util/javascript-hint.js"></script>
	<script type="text/javascript" src="codemirror-2.35/mode/javascript/javascript.js"></script>		


	<script src="console.js" type="text/javascript"></script>
</head>
<script type="text/javascript">
	$(function() {
		$( "#tabs" ).tabs();
		$("button").button();
		$("#evaluateVar").click(function() {
			evaluationOptions.evaluateVar = $(this).is(":checked");
		});
    	});
</script>
<style type="text/css">
	.error {
		color: red;
	}
	.evaluation {
		color: blue;
		font-style: italic;
	}
	.tip {
		font-style: italic;
		color: gray;
	}
	div#output pre {
		display: inline;
	}
</style>

<body>
<h1>A bit of JavaScript</h1>
<div id="tabs">
    <ul>
        <li><a href="#tabs-1">Extensible</a></li>
        <li><a href="#tabs-2">Prototype</a></li>
        <li><a href="#tabs-3">Equality</a></li>
        <li><a href="#tabs-4">Types</a></li>
        <li><a href="#tabs-5">Hoisting</a></li>
        <li><a href="#tabs-6">Visibility</a></li>
        <li><a href="#tabs-7">Undefined</a></li>
        <li><a href="#bonus">Bonus</a></li>
        <li><a href="#todo">TODO</a></li>
    </ul>
    <div id="tabs-1">        
    	<pre class="brush: js">
		var console = console || {
			log: function() {
				alert("mimic the console!");
			}
		}
	</pre>
    </div>
    <div id="tabs-2">
    	<pre class="brush: js">    
	    	function Foo() {}
	    	var foo = new Foo();
	    	foo.constructor === Foo;    
    	</pre>
    </div>
    <div id="tabs-3">
    	<pre class="brush: js">
		""           ==   "0"           // false
		0            ==   ""            // true
		0            ==   "0"           // true
		false        ==   "false"       // false
		false        ==   "0"           // true
		false        ==   undefined     // false
		false         ==   null          // false
		null          ==   undefined     // true
		" \t\r\n"    ==   0             // true

		// BUT

		""           ===   "0"           // false
		0            ===   ""            // false
		0            ===   "0"           // false
		false        ===   "false"       // false
		false        ===   "0"           // false
		false        ===   undefined     // false
		false        ===   null          // false
		null         ===   undefined     // false
		" \t\r\n"    ===   0             // false
	</pre>        
    </div>
    <div id="tabs-4">
    	<pre class="brush: js">        
    		[false.toString(),
    		(2).toString(),
    		2 .toString(),
    		2..toString()]  
    		Object.prototype.toString.call([]);
    		Object.prototype.toString.call([]).slice(8, -1);  		

    		!!"value";
    	</pre>	
    </div>
    <div id="tabs-5"> 
    	<pre class="brush: js">        
    		if (!secret) {
    			var secret = "my secret";
    		}
    		secret;
    		Foo();
    		function Foo() {}
    		bar();
    		var bar = function() {}
    		xyz;
    		var xyz;      		  		    		
    	</pre>	       
    </div>
    <div id="tabs-6"> 
    	<pre class="brush: js">
    		var bar = function Bar(x) {
    			if (x) {    				
    				Bar(0);
    			}    			
    		};
    		Bar(1);
    	</pre>
    </div>		
    <div id="tabs-7"> 
    	<pre class="brush: js">
    		var undefined = 10;
    		undefined;
    		(function(undefined) {
    			undefined;
    		})();
    		(function() {
    			var undefined;
    			undefined;
    		})();
    	</pre>
    </div>
    <div id="bonus">
    	<pre class="brush: js">
		var numbers = [1, 2, 3, 4];
		var doubled = numbers.map(function(i) { return i * 2; });
		doubled;

		var evens = numbers.filter(function(i) { return i % 2 === 0; });
		evens;
    	</pre>
    </div>
    <div id="todo">
    	<ol>    		
    		<li>display errors on the actual line, where possible</li>
    		<li>add tests (jasmine? or qunit?)</li>
    	</ol>    		    	
    </div>
</div>

<button onclick="doEvaluate()">Evaluate</button><span>(Ctrl-X)</span>
<input name="evaluateVar" id="evaluateVar" type="checkbox"><label for="evaluateVar">Evaluate "var" statement on the go</label>
<div>
	<span class="tip">Type or paste your code below (Ctrl-X - evaluate):</span>
	<table style="width: 100%">
		<tr style="width: 100%">
			<td style="width: 50%; padding: 0px;">
				<textarea id="console"></textarea>
			</td>
			<td style="width: 50%; vertical-align: top;">				
				<div class="CodeMirror">
					<div class="cm-s-default">
						<div id="output"></div>
					</div>
				</div>
			</td>
		</tr>
	</table>			
</div>
<script type="text/javascript">
	var _console = console;
	var _alert = alert;

	SyntaxHighlighter.all();	
	
      	CodeMirror.commands.autocomplete = function(cm) {
        		CodeMirror.simpleHint(cm, CodeMirror.javascriptHint);
      	};	
      	CodeMirror.commands.evaluate = function(cm) {
      		doEvaluate();        		
      	};
      	
	var myCodeMirror = CodeMirror.fromTextArea($("#console").get(0), {
		mode: "javascript",
		lineNumbers: true,
		matchBrackets: true,
		extraKeys: {"Ctrl-Space": "autocomplete", "Ctrl-X": "evaluate"}
	});

	var evaluationOptions = {
		evaluateVar: false,
		evaluateOnSemicolon: false
	};	
	
	function doEvaluate() {
		var totalLines = myCodeMirror.lineCount(),
			i,
			line,
			lines = [],
			evaluation = [],
			code,
			evaluationResult,
			linesInProgress = [],
			globalCode,
			lineHandle,
			functionDetected = false,
			resetFunctionDetected = false,
			matchingBraces = 0;			
		
		var alert = function() {}
		var console = {
			log : function() {}
		};
		
		$("#output").html("");

		setTimeout(function() {
			for (i = 0; i < totalLines; i++) {
				lineHandle = myCodeMirror.getLineHandle(i);
				line = myCodeMirror.getLine(i).trimRight();
				
				if (resetFunctionDetected) {
					functionDetected = false;
					resetFunctionDetected = false;
				}
				functionDetected = functionDetected || line.toLowerCase().indexOf("function") !== -1;
				if (functionDetected) {					
					matchingBraces += ( (line.split("{").length - 1) - (line.split("}").length - 1) );			
					if (matchingBraces === 0) {
						resetFunctionDetected = true;
					}	
				}								

				lines.push(line);

				linesInProgress.push(buildLineWithCodeMirrorStyles(lineHandle));
				if ( line.trimLeft() && ( (line.length  && (line[line.length - 1] === ";" || line[line.length - 1] === "}")) || i === totalLines - 1) )  {

					evaluationResult = undefined;
					code = lines.join("\n");
					if (line.trimLeft().indexOf("var") !== 0) {						
						try {
							evaluationResult = evaluateCode(code);
							if (evaluationResult && isArray(evaluationResult)) {
								evaluationResult = "[" + evaluationResult + "]";
							}
							if (functionDetected && matchingBraces === 0) {
								evaluationResult = undefined;
							}
							evaluation.push(colorizeEvaluationResult(linesInProgress, evaluationResult));
							linesInProgress = [];
						} catch (e) {								
							// ignore errors during the evaluation
						}
					} else {
						if (evaluationOptions.evaluateVar) {
							try {								
								// check if code is valid, i.e. can be evaluated
								evaluateCode(code);
								// code is valid, try to get the var value
								code += ("\n" + line.trimLeft().replace(/^var\s+/, ""));
								evaluationResult = evaluateCode(code);
							} catch (e) {								
								// ignore errors during the evaluation
							}
						} 

						evaluation.push(colorizeEvaluationResult(linesInProgress, evaluationResult));		
						linesInProgress = [];					
					}
				}			
			}

			
			$("#output").html(evaluation.join("<br/>"));

			alert = _alert;
			console = _console;
			try {			
				eval(lines.join("\n"));
			} catch (e) {				
				addErrorToOutput(e);				
			}
		}, $("#output").length ? 100 : 0);
	}

	function evaluateCode(code) {
		return (function() { return eval(code); })();
	}

	function colorizeEvaluationResult(linesInProgress, evaluationResult) {
		return linesInProgress.join("<br/>") + "&nbsp;&nbsp;&nbsp;<span class='evaluation'>&gt;&gt;&gt; " + evaluationResult + "</span>";
	}

	function addErrorToOutput(error) {
		$("#output").html($("#output").html() + "<br/><br/>" + colorizeError(error));
	}

	function colorizeError(error) {
		return "<span class='error'>========== Error ==========</span><br/><span class='error'>" + error + "</span>";
	}

	function buildLineWithCodeMirrorStyles(lineHandle) {
		var styles = lineHandle.styles, 
			text,
			style,
			i,			
			styledLines = [];
		for (i = 0; i < styles.length; i += 2) {
			text = styles[i];
			style = styles[i+1];
			if (style) {
				styledLines.push("<span class='cm-" + style + "'>" + text + "</span>");
			} else {
				styledLines.push(text);
			}
		}	
		return "<pre>" + styledLines.join("") + "</pre>";
	}

	function isArray(obj) {
		return Object.prototype.toString.call(obj).slice(8, -1) === "Array";
	}

	String.prototype.trimRight = String.prototype.trimRight || function() {
		return this.replace(/\s+$/g, "");
	};

	String.prototype.trimLeft = String.prototype.trimLeft || function() {
		return this.replace(/^\s+/g, "");
	};
</script>
</body>
</html>